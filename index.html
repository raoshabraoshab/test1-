<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ðŸ’¬ Vikrant Chat Rooms</title>
  <style>
    body{margin:0;font-family:sans-serif;background:linear-gradient(135deg,#36d1dc,#5b86e5);display:flex;justify-content:center;align-items:center;height:100vh}
    .card{width:100%;max-width:700px;background:#fff;padding:20px;border-radius:20px;box-shadow:0 10px 25px rgba(0,0,0,0.3);}
    h2{text-align:center;margin-top:0}
    #roomSelect{margin-bottom:10px;width:100%;padding:8px;border-radius:6px;border:1px solid #ccc}
    #messages{height:350px;overflow:auto;border:1px solid #ddd;border-radius:10px;padding:10px;margin-bottom:10px;background:#f9f9f9}
    .msg{margin-bottom:8px;padding:6px 10px;background:#e6f0ff;border-radius:6px}
    .msg strong{color:#007aff}
    form{display:flex;gap:6px}
    input,button{padding:10px;border-radius:8px;border:1px solid #ccc}
    input{flex:1}
    button{background:#007aff;color:white;cursor:pointer;border:none}
    button:hover{background:#0056b3}
  </style>
</head>
<body>
  <div class="card">
    <h2>ðŸ’¬ Vikrant Chat</h2>

    <select id="roomSelect"></select>
    <button id="newChatBtn" style="margin-bottom:10px;background:#28a745">ðŸ†• New Chat Room</button>

    <div id="messages">Loading...</div>

    <form id="sendForm">
      <input id="nameInput" placeholder="Apna naam" required />
      <input id="msgInput" placeholder="Type message..." required />
      <button type="submit">Send</button>
    </form>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://unxzmzcuhbmgwjovsoot.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVueHptemN1aGJtZ3dqb3Zzb290Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNDY1NzgsImV4cCI6MjA3MjYyMjU3OH0.yeHlQCLWcGwGVN8_4rKYUJYVSKrMUd73QR8eeVBMNQo";
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    const messagesEl = document.getElementById('messages');
    const roomSelect = document.getElementById('roomSelect');
    const sendForm = document.getElementById('sendForm');
    const nameInput = document.getElementById('nameInput');
    const msgInput = document.getElementById('msgInput');
    const newChatBtn = document.getElementById('newChatBtn');

    let currentRoom = "room1"; // default room
    let channel;

    // HTML escaping
    function escapeHtml(s){ return (s+'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    function appendMessage(rec){
      const d=document.createElement('div');
      d.className='msg';
      const time=new Date(rec.created_at).toLocaleTimeString();
      d.innerHTML=`<strong>${escapeHtml(rec.name)}</strong> <small>${time}</small><div>${escapeHtml(rec.message)}</div>`;
      messagesEl.appendChild(d);
      messagesEl.scrollTop=messagesEl.scrollHeight;
    }

    async function loadRooms(){
      const { data } = await supabaseClient.from('messages').select('room').neq('room',null);
      const rooms=[...new Set(data.map(r=>r.room))];
      roomSelect.innerHTML="";
      rooms.forEach(r=>{
        const opt=document.createElement('option');
        opt.value=r; opt.textContent=r;
        if(r===currentRoom) opt.selected=true;
        roomSelect.appendChild(opt);
      });
    }

    async function loadMessages(){
      const { data } = await supabaseClient
        .from('messages')
        .select('*')
        .eq('room',currentRoom)
        .order('created_at',{ascending:true});
      messagesEl.innerHTML="";
      data.forEach(appendMessage);
    }

    function subscribeRoom(){
      if(channel) supabaseClient.removeChannel(channel);
      channel = supabaseClient.channel('room:'+currentRoom);
      channel.on('postgres_changes',{event:'INSERT',schema:'public',table:'messages',filter:`room=eq.${currentRoom}`},({new:row})=>{
        appendMessage(row);
      }).subscribe();
    }

    roomSelect.addEventListener('change',async()=>{
      currentRoom=roomSelect.value;
      await loadMessages();
      subscribeRoom();
    });

    sendForm.addEventListener('submit',async e=>{
      e.preventDefault();
      const name=nameInput.value.trim()||"Anon";
      const message=msgInput.value.trim();
      if(!message) return;
      await supabaseClient.from('messages').insert([{name,message,room:currentRoom}]);
      msgInput.value="";
    });

    newChatBtn.addEventListener('click',()=>{
      const newRoom="room"+Date.now();
      currentRoom=newRoom;
      const opt=document.createElement('option');
      opt.value=newRoom; opt.textContent=newRoom; opt.selected=true;
      roomSelect.appendChild(opt);
      messagesEl.innerHTML="";
      subscribeRoom();
    });

    (async()=>{
      await loadRooms();
      await loadMessages();
      subscribeRoom();
    })();
  </script>
</body>
</html>
